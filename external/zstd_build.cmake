INCLUDE(ExternalProject)

set(ZSTD_SOURCES_DIR ${THIRD_PARTY_PATH}/zstd)
set(ZSTD_INCLUDE_DIR ${ZSTD_INSTALL_PATH}/include)

set(ZSTD_URL "https://github.com/facebook/zstd/releases/download/v1.4.4/zstd-1.4.4.tar.gz")

if (ANDROID)
    set(ANDROID_ABI_ARG -DANDROID_ABI=${ANDROID_ABI})
    set(ANDROID_PLATFORM_ARG -DANDROID_PLATFORM=${ANDROID_PLATFORM})
    set(ANDROID_NDK_ARG -DANDROID_NDK=${ANDROID_NDK})
    set(ANDROID_TOOLCHAIN_FILE_ARG -DCMAKE_TOOLCHAIN_FILE=${CMAKE_TOOLCHAIN_FILE})
endif ()

if (ZSTD_USE_STATIC)
    set(SHARED_OR_STATIC "STATIC")
    set(LIB_SUFFIX ${CMAKE_STATIC_LIBRARY_SUFFIX})
else ()
    set(SHARED_OR_STATIC "SHARED")
    set(LIB_SUFFIX ${CMAKE_SHARED_LIBRARY_SUFFIX})
endif ()

if (THIRD_PARTY_INDEPENDENT_INSTALL)
    set(SEARCH_GFLAGS ${THIRD_PARTY_INSTALL_PATH}/gflags)
else ()
    set(SEARCH_GFLAGS ${THIRD_PARTY_INSTALL_PATH})
endif ()

ExternalProject_Add(
        extern_zstd
        URL ${ZSTD_URL}
        PREFIX ${ZSTD_SOURCES_DIR}
        UPDATE_COMMAND ""
        CMAKE_ARGS
        ${ANDROID_ABI_ARG}
        ${ANDROID_PLATFORM_ARG}
        ${ANDROID_NDK_ARG}
        ${ANDROID_TOOLCHAIN_FILE_ARG}
        -DCMAKE_INSTALL_PREFIX=${ZSTD_INSTALL_PATH}
        -DCMAKE_POSITION_INDEPENDENT_CODE=ON
        -DBUILD_TESTING=OFF
        -DCMAKE_BUILD_TYPE=${THIRD_PARTY_BUILD_TYPE}
        CMAKE_CACHE_ARGS -DCMAKE_INSTALL_PREFIX:PATH=${ZSTD_INSTALL_PATH}
        -DCMAKE_POSITION_INDEPENDENT_CODE:BOOL=ON
        -DCMAKE_BUILD_TYPE:STRING=${THIRD_PARTY_BUILD_TYPE}
        SOURCE_SUBDIR build/cmake
        BUILD_ALWAYS FALSE
)


set(ZSTD_LIBRARY "${ZSTD_INSTALL_PATH}/lib/libzstd${LIB_SUFFIX}" CACHE FILEPATH "ZSTD_LIBRARY" FORCE)

add_library(zstd ${SHARED_OR_STATIC} IMPORTED GLOBAL)
set_property(TARGET zstd PROPERTY IMPORTED_LOCATION ${ZSTD_LIBRARY})

include_directories(${ZSTD_INCLUDE_DIR})
set(ZSTD_INCLUDE_DIRS ${ZSTD_INCLUDE_DIR})
set(ZSTD_LIBRARIES ${ZSTD_LIBRARY})

### restore
set(SHARED_OR_STATIC)
set(LIB_SUFFIX)