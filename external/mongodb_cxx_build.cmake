include(ExternalProject)

set(MONGODBCXX_SOURCES_DIR ${THIRD_PARTY_PATH}/mongodbcxx)
set(MONGODBCXX_INCLUDE_DIR ${MONGODBCXX_INSTALL_PATH}/include/mongocxx/v_noabi)
set(BSONCXX_INCLUDE_DIR ${MONGODBCXX_INSTALL_PATH}/include/bsoncxx/v_noabi)

set(MONGODBCXX_URL "https://github.com/mongodb/mongo-cxx-driver/releases/download/r3.5.0/mongo-cxx-driver-r3.5.0.tar.gz")

if (ANDROID)
    set(ANDROID_ABI_ARG -DANDROID_ABI=${ANDROID_ABI})
    set(ANDROID_PLATFORM_ARG -DANDROID_PLATFORM=${ANDROID_PLATFORM})
    set(ANDROID_NDK_ARG -DANDROID_NDK=${ANDROID_NDK})
    set(ANDROID_TOOLCHAIN_FILE_ARG -DCMAKE_TOOLCHAIN_FILE=${CMAKE_TOOLCHAIN_FILE})
endif()

ExternalProject_Add(
        extern_mongodbcxx
        DEPENDS mongodb bason
        URL ${MONGODBCXX_URL}
        PREFIX ${MONGODBCXX_SOURCES_DIR}
        UPDATE_COMMAND ""
        CMAKE_ARGS
        ${ANDROID_ABI_ARG}
        ${ANDROID_PLATFORM_ARG}
        ${ANDROID_NDK_ARG}
        ${ANDROID_TOOLCHAIN_FILE_ARG}
        -DCMAKE_CXX_STANDARD=${CMAKE_CXX_STANDARD}
        -DCMAKE_INSTALL_PREFIX=${MONGODBCXX_INSTALL_PATH}
        -DCMAKE_POSITION_INDEPENDENT_CODE=ON
        -DCMAKE_BUILD_TYPE=${THIRD_PARTY_BUILD_TYPE}
        -DBUILD_SHARED_AND_STATIC_LIBS=ON
#        -DBUILD_SHARED_LIBS_WITH_STATIC_MONGOC=ON
        -DCMAKE_PREFIX_PATH=${THIRD_PARTY_INSTALL_PATH}
        CMAKE_CACHE_ARGS -DCMAKE_INSTALL_PREFIX:PATH=${MONGODBCXX_INSTALL_PATH}
        -DCMAKE_POSITION_INDEPENDENT_CODE:BOOL=ON
        -DCMAKE_BUILD_TYPE:STRING=${THIRD_PARTY_BUILD_TYPE}
        BUILD_ALWAYS FALSE
)


if (MONGODBCXX_USE_STATIC)
    set(SHARED_OR_STATIC "STATIC")
    set(LIB_SUFFIX ${CMAKE_STATIC_LIBRARY_SUFFIX})
    set(MONGODBCXX_LIBRARY "${MONGODBCXX_INSTALL_PATH}/lib/libmongocxx-static.a" CACHE FILEPATH "MONGODBCXX_LIBRARY" FORCE)
    set(BSONCXX_LIBRARY "${MONGODBCXX_INSTALL_PATH}/lib/libbsoncxx-static.a" CACHE FILEPATH "BSONCXX_LIBRARY" FORCE)
else ()
    set(SHARED_OR_STATIC "SHARED")
    set(LIB_SUFFIX ${CMAKE_SHARED_LIBRARY_SUFFIX})
    set(MONGODBCXX_LIBRARY "${MONGODBCXX_INSTALL_PATH}/lib/libmongocxx.so" CACHE FILEPATH "MONGODBCXX_LIBRARY" FORCE)
    set(BSONCXX_LIBRARY "${MONGODBCXX_INSTALL_PATH}/lib/libbsoncxx.so" CACHE FILEPATH "BSONCXX_LIBRARY" FORCE)
endif ()



add_library(mongodbcxx ${SHARED_OR_STATIC} IMPORTED GLOBAL)
set_property(TARGET mongodbcxx PROPERTY IMPORTED_LOCATION ${MONGODBCXX_LIBRARY})
add_dependencies(mongodbcxx extern_mongodbcxx)

add_library(bsoncxx ${SHARED_OR_STATIC} IMPORTED GLOBAL)
set_property(TARGET bsoncxx PROPERTY IMPORTED_LOCATION ${BSONCXX_LIBRARY})
add_dependencies(bsoncxx extern_mongodbcxx)

include_directories(${MONGODBCXX_INCLUDE_DIR})
include_directories(${BSONCXX_INCLUDE_DIR})
set(MONGODBCXX_INCLUDE_DIRS ${MONGODBCXX_INCLUDE_DIR})
set(MONGODBCXX_LIBRARIES ${MONGODBCXX_LIBRARY})
set(BSONCXX_INCLUDE_DIRS ${BSONCXX_INCLUDE_DIR})
set(BSONBCXX_LIBRARIES ${BSONCXX_LIBRARY})

### restore
set(SHARED_OR_STATIC)
set(LIB_SUFFIX)